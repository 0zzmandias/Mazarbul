generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USUÁRIOS E PERFIL
// ==========================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  handle    String   @unique
  password  String

  bio       String?  @db.Text
  avatarUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reviews       Review[]
  achievements  UserAchievement[]
  favorites     MediaReference[] @relation("UserFavorites")
}

// ==========================================
// MÍDIA (CACHE & CATALOGO)
// ==========================================

model MediaReference {
  // ID canônico (QID) ou ID legado (ex: "tmdb_550", "ol_OL123W", "lastfm_xxx")
  id          String   @id

  // "filme" | "livro" | "jogo" | "album"
  type        String

  // { "PT": "...", "EN": "...", "ES": "...", "DEFAULT": "..." }
  titles      Json

  synopses    Json?

  posterUrl   String?
  backdropUrl String?

  releaseYear Int?

  runtime     Int?
  director    String?

  // UI-friendly (pode ser legado enquanto migramos)
  genres      Json?
  countries   Json?

  details     Json?

  tags        String[]
  externalIds Json?

  // Canonicalização/performance
  isStub         Boolean   @default(false)
  lastFetchedAt  DateTime?
  lastAccessedAt DateTime?
  countrySource  String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  favoritedBy User[]   @relation("UserFavorites")
  reviews     Review[]

  aliases     MediaAlias[]
  mediaGenres MediaGenre[]

  @@index([type])
  @@index([type, releaseYear])
  @@index([lastAccessedAt])
}

// ==========================================
// BUSCA / ALIASES (DB-first)
// ==========================================

model MediaAlias {
  id              String   @id
  canonicalId     String
  canonical       MediaReference @relation(fields: [canonicalId], references: [id], onDelete: Cascade)

  type            String   // "filme" | "livro" | "jogo" | "album"
  lang            String   // "PT" | "EN" | "ES"

  title           String
  titleRaw        String
  titleNormalized String

  source          String   // "wikidata.label" | "wikidata.alias" | etc
  lastAccessedAt  DateTime @default(now())

  createdAt       DateTime @default(now())

  @@index([lastAccessedAt])
  @@index([type, lang, titleNormalized])
}

// ==========================================
// GÊNERO CANÔNICO (para troféus)
// ==========================================

model Genre {
  // Sugestão: usar o QID do gênero como id (ex: "Q132311")
  id        String   @id

  // slug limpo (ex: "fantasy")
  slug      String   @unique

  // { "PT": "Fantasia", "EN": "Fantasy", "ES": "Fantasía" }
  titles    Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mediaGenres MediaGenre[]
}

model MediaGenre {
  mediaId   String
  genreId   String

  media     MediaReference @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  genre     Genre          @relation(fields: [genreId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@id([mediaId, genreId])
  @@index([genreId])
  @@index([mediaId])
}

// ==========================================
// REVIEWS E AVALIAÇÕES
// ==========================================

model Review {
  id        String   @id @default(uuid())

  rating    Float
  content   String?  @db.Text
  tags      String[]
  containsSpoilers Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  mediaId   String
  media     MediaReference @relation(fields: [mediaId], references: [id])
}

// ==========================================
// GAMIFICAÇÃO (TROFÉUS)
// ==========================================

model UserAchievement {
  id            String   @id @default(uuid())
  achievementId String
  unlockedAt    DateTime @default(now())
  progress      Int      @default(0)

  userId        String
  user          User     @relation(fields: [userId], references: [id])

  @@unique([userId, achievementId])
}
